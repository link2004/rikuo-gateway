# 自動化とスケーリング

## 概要

Claude Codeは単なる対話ツールではない。CI/CD、プリコミットフック、スクリプトに組み込んで自動化できる。複数のセッションを並列実行することで、開発速度を大幅に向上させられる。

---

## 8.1 ヘッドレスモードで実行

```bash
# ワンオフクエリ
claude -p "このプロジェクトが何をしているか説明して"

# スクリプト用の構造化出力
claude -p "すべてのAPIエンドポイントをリストして" --output-format json

# リアルタイム処理用ストリーミング
claude -p "このログファイルを分析して" --output-format stream-json
```

### 出力フォーマット

- プレーンテキスト
- JSON
- ストリーミングJSON

---

## 8.2 複数のClaudeセッションを実行

### 2つのアプローチ

1. **Claude Desktop** - 複数のローカルセッションを視覚的に管理
   - 各セッションが分離されたワークツリーを持つ

2. **Claude Code on the Web** - クラウドインフラ
   - Anthropicのセキュアなインフラで実行
   - 分離されたVM

### 品質ワークフロー - Writer/Reviewerパターン

**セッションA（Writer）:**
```
APIエンドポイントにレートリミッターを実装して
```

**セッションB（Reviewer）:**
```
@src/middleware/rateLimiter.ts のレートリミッター実装をレビューして。
エッジケース、レース条件、既存のミドルウェアパターンとの一貫性を確認して。
```

**セッションA（対応）:**
```
レビューのフィードバック: [セッションBの出力]。これらの問題に対処して。
```

### 代替パターン

- 一方のClaudeがテストを書き、もう一方がそれをパスするコードを書く
- コードレビュー用のフレッシュなコンテキスト（書いた時のバイアスなし）

---

## 8.3 ファイル全体にファンアウト

### 大規模なマイグレーション/分析向け

**Step 1:** タスクリストを生成
```bash
マイグレーションが必要な2,000個のPythonファイルをすべてリストして
```

**Step 2:** ループスクリプトを作成
```bash
for file in $(cat files.txt); do
  claude -p "$file をReactからVueにマイグレート。OKまたはFAILを返して" \
    --allowedTools "Edit,Bash(git commit:*)"
done
```

**Step 3:** 数ファイルでテストしてからスケール
- 最初の2-3ファイルでプロンプトを改良
- `--allowedTools`で無人実行用にフルセットを実行

### 結果をパイプ

```bash
claude -p "<プロンプト>" --output-format json | your_command
```

### デバッグ

```bash
--verbose  # 詳細を表示（開発時）
```

---

## 8.4 安全な自律モード

```bash
claude --dangerously-skip-permissions
```

### ユースケース

- リントエラーの修正
- ボイラープレートの生成

### リスク

- データ損失、システム破損、データ流出
- インターネットなしのコンテナでのみ使用

### より安全な代替

代わりに`/sandbox`でサンドボックスを使用。

---

## まとめ

> 「Claude Codeは対話ツールを超えた自動化プラットフォーム」

ヘッドレスモード、並列セッション、ファンアウトパターン—これらを組み合わせることで、開発ワークフローを大幅に効率化できる。
